<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InkHale Vapeshop — Business Dashboard</title>
  <style>
    :root{--bg:#0b1020;--card:#ffffff;--text:#0d0d0d;--muted:#6b7280;--accent:#2563eb}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(135deg,#0b1020,#111827);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111}
    header{max-width:1200px;margin:24px auto 0;padding:0 16px}
    .app{max-width:1200px;margin:16px auto 40px;padding:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:.15s}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 220px}
    .p16{padding:16px} .p20{padding:20px}
    h1{color:#fff;font-size:28px;margin:8px 0 14px}
    h2{font-size:18px;margin:0 0 10px} h3{font-size:14px;margin:12px 0;color:#374151}
    label{display:block;font-size:12px;color:#374151;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
    textarea{min-height:70px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{font-size:12px;color:#6b7280;text-align:left;padding:10px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb}
    tbody td{padding:10px 12px;border-bottom:1px solid #f1f5f9;font-size:14px}
    tbody tr:hover{background:#fafafa}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.alt{background:#fff;color:#111;border:1px solid #e5e7eb}
    .btn.warn{background:#ef4444}
    .kpi{padding:14px;border-radius:12px;background:#f9fafb;border:1px solid #e5e7eb}
    .kpi .val{font-size:20px;font-weight:800}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .right{margin-left:auto}
    .muted{color:#6b7280}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:820px){.grid3{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}
    @media print{body{background:#fff} .tabs, .toolbar, #navTitle, #authBar{display:none} header{margin:0} .app{margin:0} .card{box-shadow:none;border:none}}

    /* auth */
    #lock{position:fixed;inset:0;background:linear-gradient(135deg,#0b1020,#0e172b);display:flex;align-items:center;justify-content:center;z-index:50}
    #lock .panel{width:min(520px,92%);background:#fff;border-radius:16px;padding:22px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .center{display:flex;align-items:center;justify-content:space-between;gap:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- SIMPLE AUTH (local-only) -->
  <div id="lock" hidden>
    <div class="panel">
      <h2 style="margin:0 0 10px">InkHale Vapeshop — Sign in</h2>
      <div class="row">
        <div class="col"><label>User ID</label><input id="authUser" placeholder="e.g., owner" /></div>
        <div class="col"><label>Password</label><input id="authPass" type="password" placeholder="••••••" /></div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn" id="btnLogin">Login</button>
        <button class="btn alt" id="btnSet">Set/Change Credentials</button>
        <div class="right muted">Local-only (stored on your device)</div>
      </div>
    </div>
  </div>

  <header>
    <div class="center" id="authBar">
      <h1 id="navTitle">InkHale Vapeshop — Business Dashboard</h1>
      <div class="muted" id="authWho"></div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="income">Income</button>
      <button class="tab" data-tab="expenses">Expenses</button>
      <button class="tab" data-tab="inventory">Inventory</button>
      <button class="tab" data-tab="compare">Comparison</button>
      <button class="tab" data-tab="print">Print / Export</button>
    </div>
  </header>

  <main class="app">
    <!-- INCOME -->
    <section id="tab-income" class="card p20">
      <div class="toolbar" style="margin-bottom:12px">
        <div class="row" style="flex:1">
          <div class="col"><label>From</label><input type="date" id="incFrom"></div>
          <div class="col"><label>To</label><input type="date" id="incTo"></div>
          <div class="col"><label>Method</label><select id="incMethod"><option value="">All</option><option>Cash</option><option>GCash</option><option>Card</option><option>Bank</option></select></div>
          <div class="col"><label>Category</label><input id="incCat" placeholder="e.g., Sales" /></div>
        </div>
        <div class="right">
          <button class="btn" id="addIncome">Add Income</button>
        </div>
      </div>
      <div class="row">
        <div class="col card p16">
          <h2>Add / Edit</h2>
          <div class="grid2">
            <div class="col"><label>Date</label><input type="date" id="incDate"></div>
            <div class="col"><label>Amount</label><input type="number" step="0.01" id="incAmt"></div>
            <div class="col"><label>Category</label><input id="incCategory" placeholder="Sales"></div>
            <div class="col"><label>Method</label><select id="incMeth"><option>Cash</option><option>GCash</option><option>Card</option><option>Bank</option></select></div>
          </div>
          <label style="margin-top:8px">Note</label>
          <textarea id="incNote" placeholder="Optional"></textarea>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" id="saveIncome">Save</button>
            <button class="btn alt" id="resetIncome">Clear</button>
          </div>
        </div>
        <div class="col" style="flex:2 1 520px">
          <div class="card p16">
            <h2>Income List</h2>
            <div style="overflow:auto"><table id="incTable"><thead><tr><th>Date</th><th>Category</th><th>Method</th><th>Note</th><th>Amount</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="tab-expenses" class="card p20" hidden>
      <div class="toolbar" style="margin-bottom:12px">
        <div class="row" style="flex:1">
          <div class="col"><label>From</label><input type="date" id="expFrom"></div>
          <div class="col"><label>To</label><input type="date" id="expTo"></div>
          <div class="col"><label>Method</label><select id="expMethod"><option value="">All</option><option>Cash</option><option>GCash</option><option>Card</option><option>Bank</option></select></div>
          <div class="col"><label>Category</label><input id="expCat" placeholder="e.g., Utilities" /></div>
        </div>
        <div class="right">
          <button class="btn" id="addExpense">Add Expense</button>
        </div>
      </div>
      <div class="row">
        <div class="col card p16">
          <h2>Add / Edit</h2>
          <div class="grid2">
            <div class="col"><label>Date</label><input type="date" id="expDate"></div>
            <div class="col"><label>Amount</label><input type="number" step="0.01" id="expAmt"></div>
            <div class="col"><label>Category</label><input id="expCategory" placeholder="Rent"></div>
            <div class="col"><label>Method</label><select id="expMeth"><option>Cash</option><option>GCash</option><option>Card</option><option>Bank</option></select></div>
          </div>
          <label style="margin-top:8px">Note</label>
          <textarea id="expNote" placeholder="Optional"></textarea>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" id="saveExpense">Save</button>
            <button class="btn alt" id="resetExpense">Clear</button>
          </div>
        </div>
        <div class="col" style="flex:2 1 520px">
          <div class="card p16">
            <h2>Expense List</h2>
            <div style="overflow:auto"><table id="expTable"><thead><tr><th>Date</th><th>Category</th><th>Method</th><th>Note</th><th>Amount</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="tab-inventory" class="card p20" hidden>
      <div class="toolbar" style="margin-bottom:10px">
        <div class="row" style="flex:1">
          <div class="col"><label>Search</label><input id="invSearch" placeholder="SKU / Name / Category"></div>
        </div>
        <div class="right">
          <button class="btn" id="invAdd">Add Item</button>
        </div>
      </div>
      <div class="row">
        <div class="col card p16">
          <h2>Add / Edit Item</h2>
          <div class="grid2">
            <div class="col"><label>SKU</label><input id="sku"></div>
            <div class="col"><label>Name</label><input id="name"></div>
            <div class="col"><label>Category</label><input id="cat"></div>
            <div class="col"><label>Cost</label><input type="number" step="0.01" id="cost"></div>
            <div class="col"><label>Price</label><input type="number" step="0.01" id="price"></div>
            <div class="col"><label>Qty</label><input type="number" step="1" id="qty"></div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" id="invSave">Save Item</button>
            <button class="btn alt" id="invClear">Clear</button>
          </div>
          <h3>Bulk CSV Upload</h3>
          <div class="row">
            <div class="col"><input type="file" id="csv" accept=".csv"></div>
            <div class="col muted">Columns: <code>sku,name,category,cost,price,qty</code></div>
          </div>
        </div>
        <div class="col" style="flex:2 1 520px">
          <div class="card p16">
            <h2>Inventory</h2>
            <div style="overflow:auto"><table id="invTable"><thead><tr><th>SKU</th><th>Name</th><th>Category</th><th>Cost</th><th>Price</th><th>Qty</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <!-- COMPARISON -->
    <section id="tab-compare" class="card p20" hidden>
      <div class="row">
        <div class="col card p16">
          <h2>Cash Balances per Month</h2>
          <div class="grid2">
            <div class="col"><label>Month</label><select id="cbMonth"></select></div>
            <div class="col"><label>Year</label><input id="cbYear" type="number" value="2025"></div>
            <div class="col"><label>Cash on Hand</label><input id="cbCash" type="number" step="0.01"></div>
            <div class="col"><label>GCash Amount</label><input id="cbGcash" type="number" step="0.01"></div>
          </div>
          <div class="toolbar" style="margin-top:10px"><button class="btn" id="cbSave">Save Month Balance</button></div>
        </div>
        <div class="col card p16">
          <h2>Pick Year to Compare</h2>
          <div class="grid2">
            <div class="col"><label>Year</label><input id="cmpYear" type="number" value="2025"></div>
          </div>
          <div class="toolbar" style="margin-top:10px"><button class="btn" id="cmpRun">Run Comparison</button></div>
        </div>
      </div>

      <div class="grid3" style="margin:12px 0">
        <div class="kpi"><div class="muted">Total Income</div><div class="val" id="cmpIncome">0</div></div>
        <div class="kpi"><div class="muted">Total Expenses</div><div class="val" id="cmpExpense">0</div></div>
        <div class="kpi"><div class="muted">Net Profit</div><div class="val" id="cmpNet">0</div></div>
      </div>

      <div class="card p16" style="margin-top:8px">
        <h2>Monthly Profit vs Cash on Hand + GCash</h2>
        <canvas id="chartProfit" height="130"></canvas>
      </div>
    </section>

    <!-- PRINT/EXPORT -->
    <section id="tab-print" class="card p20" hidden>
      <h2>Print & Export</h2>
      <div class="toolbar" style="margin:8px 0">
        <button class="btn" onclick="window.print()">Print</button>
        <button class="btn alt" id="btnExport">Export All (.xlsx)</button>
        <button class="btn warn" id="btnReset">Reset All Data</button>
      </div>
      <div class="card p16">
        <h3>Quick Preview</h3>
        <div style="overflow:auto"><table id="preview"><thead></thead><tbody></tbody></table></div>
      </div>
    </section>
  </main>

<script>
  // =============== Storage & Auth ===================
  const KEY='INKHALE_DB_v1';
  const AUTH='INKHALE_AUTH';
  const monthNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const $=sel=>document.querySelector(sel);

  function load(){ const raw=localStorage.getItem(KEY); return raw? JSON.parse(raw): { income:[], expenses:[], inventory:[], cash:{}, user:''}; }
  function save(d){ localStorage.setItem(KEY, JSON.stringify(d)); renderPreview(); }

  function showLock(){ $('#lock').hidden=false; }
  function hideLock(){ $('#lock').hidden=true; }
  function getAuth(){ const raw=localStorage.getItem(AUTH); return raw? JSON.parse(raw): null; }
  function setAuth(user,pass){ localStorage.setItem(AUTH, JSON.stringify({user,pass})); }

  function bootAuth(){
    const who = getAuth();
    if(!who){
      // first-time: set default credentials
      setAuth('owner','inkhale123');
    }
    $('#authWho').textContent = 'Signed in as: ' + (load().user || '—');
    showLock();
  }

  $('#btnLogin').addEventListener('click',()=>{
    const a=getAuth(); const u=$('#authUser').value.trim(); const p=$('#authPass').value;
    if(!a || u===a.user && p===a.pass){ const d=load(); d.user=u||a.user; save(d); $('#authWho').textContent='Signed in as: '+(d.user||a.user); hideLock(); return; }
    alert('Invalid credentials');
  });
  $('#btnSet').addEventListener('click',()=>{
    const user=prompt('Set User ID'); if(!user) return; const pass=prompt('Set Password'); if(!pass) return; setAuth(user,pass); alert('Credentials updated. Use them to login.');
  });

  // =============== Helpers ===================
  function fmt(n){ if(n==null||n==='') return '0'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function id(){ return Math.random().toString(36).slice(2,10); }
  function parseDate(s){ return s? new Date(s): new Date(); }

  function filterByDate(rows,from,to){
    const f = from? new Date(from): null; const t = to? new Date(to): null;
    return rows.filter(r=>{ const d=new Date(r.date); if(f && d< f) return false; if(t && d> t) return false; return true; });
  }

  // =============== Income ===================
  let editIncomeId=null;
  function renderIncome(){
    const d=load();
    const rows = filterByDate(d.income, $('#incFrom').value, $('#incTo').value)
      .filter(r=> $('#incMethod').value? r.method===$('#incMethod').value: true)
      .filter(r=> $('#incCat').value? (r.category||'').toLowerCase().includes($('#incCat').value.toLowerCase()): true)
      .sort((a,b)=> new Date(b.date)-new Date(a.date));
    const tb=$('#incTable tbody'); tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.date}</td><td>${r.category||''}</td><td>${r.method||''}</td><td>${r.note||''}</td><td><b>${fmt(r.amount)}</b></td>
      <td><button class='btn alt' data-e='${r.id}'>Edit</button> <button class='btn warn' data-x='${r.id}'>Del</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-e]').forEach(b=> b.onclick=()=>{
      const r=d.income.find(x=>x.id===b.getAttribute('data-e'));
      editIncomeId=r.id; $('#incDate').value=r.date; $('#incAmt').value=r.amount; $('#incCategory').value=r.category||''; $('#incMeth').value=r.method||'Cash'; $('#incNote').value=r.note||'';
    });
    tb.querySelectorAll('button[data-x]').forEach(b=> b.onclick=()=>{ if(confirm('Delete this income?')){ const id=b.getAttribute('data-x'); d.income=d.income.filter(x=>x.id!==id); save(d); renderIncome(); } });
  }
  $('#saveIncome').addEventListener('click',()=>{
    const d=load(); const row={ id: editIncomeId||id(), date: $('#incDate').value || new Date().toISOString().slice(0,10), amount: Number($('#incAmt').value||0), category: $('#incCategory').value||'Sales', method: $('#incMeth').value||'Cash', note: $('#incNote').value||'' };
    if(editIncomeId){ const i=d.income.findIndex(r=>r.id===editIncomeId); d.income[i]=row; } else { d.income.push(row); }
    save(d); editIncomeId=null; $('#incDate').value=''; $('#incAmt').value=''; $('#incCategory').value=''; $('#incMeth').value='Cash'; $('#incNote').value=''; renderIncome();
  });
  $('#resetIncome').addEventListener('click',()=>{ editIncomeId=null; $('#incDate').value=$('#incAmt').value=$('#incCategory').value=$('#incNote').value=''; $('#incMeth').value='Cash'; });
  ['incFrom','incTo','incMethod','incCat'].forEach(id=> $('#'+id).addEventListener('change', renderIncome));
  $('#addIncome').addEventListener('click',()=>{ editIncomeId=null; $('#incDate').value=new Date().toISOString().slice(0,10); $('#incAmt').focus(); });

  // =============== Expenses ===================
  let editExpenseId=null;
  function renderExpenses(){
    const d=load();
    const rows = filterByDate(d.expenses, $('#expFrom').value, $('#expTo').value)
      .filter(r=> $('#expMethod').value? r.method===$('#expMethod').value: true)
      .filter(r=> $('#expCat').value? (r.category||'').toLowerCase().includes($('#expCat').value.toLowerCase()): true)
      .sort((a,b)=> new Date(b.date)-new Date(a.date));
    const tb=$('#expTable tbody'); tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.date}</td><td>${r.category||''}</td><td>${r.method||''}</td><td>${r.note||''}</td><td><b>${fmt(r.amount)}</b></td>
      <td><button class='btn alt' data-e='${r.id}'>Edit</button> <button class='btn warn' data-x='${r.id}'>Del</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-e]').forEach(b=> b.onclick=()=>{
      const r=d.expenses.find(x=>x.id===b.getAttribute('data-e'));
      editExpenseId=r.id; $('#expDate').value=r.date; $('#expAmt').value=r.amount; $('#expCategory').value=r.category||''; $('#expMeth').value=r.method||'Cash'; $('#expNote').value=r.note||'';
    });
    tb.querySelectorAll('button[data-x]').forEach(b=> b.onclick=()=>{ if(confirm('Delete this expense?')){ const id=b.getAttribute('data-x'); d.expenses=d.expenses.filter(x=>x.id!==id); save(d); renderExpenses(); } });
  }
  $('#saveExpense').addEventListener('click',()=>{
    const d=load(); const row={ id: editExpenseId||id(), date: $('#expDate').value || new Date().toISOString().slice(0,10), amount: Number($('#expAmt').value||0), category: $('#expCategory').value||'Expense', method: $('#expMeth').value||'Cash', note: $('#expNote').value||'' };
    if(editExpenseId){ const i=d.expenses.findIndex(r=>r.id===editExpenseId); d.expenses[i]=row; } else { d.expenses.push(row); }
    save(d); editExpenseId=null; $('#expDate').value=''; $('#expAmt').value=''; $('#expCategory').value=''; $('#expMeth').value='Cash'; $('#expNote').value=''; renderExpenses();
  });
  $('#resetExpense').addEventListener('click',()=>{ editExpenseId=null; $('#expDate').value=$('#expAmt').value=$('#expCategory').value=$('#expNote').value=''; $('#expMeth').value='Cash'; });
  ['expFrom','expTo','expMethod','expCat'].forEach(id=> $('#'+id).addEventListener('change', renderExpenses));
  $('#addExpense').addEventListener('click',()=>{ editExpenseId=null; $('#expDate').value=new Date().toISOString().slice(0,10); $('#expAmt').focus(); });

  // =============== Inventory ===================
  let editInv=null;
  function renderInventory(){
    const d=load(); const q=$('#invSearch').value.toLowerCase();
    const rows=d.inventory.filter(r=> (r.sku||'').toLowerCase().includes(q) || (r.name||'').toLowerCase().includes(q) || (r.category||'').toLowerCase().includes(q));
    const tb=$('#invTable tbody'); tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.sku}</td><td>${r.name}</td><td>${r.category||''}</td><td>${fmt(r.cost)}</td><td>${fmt(r.price)}</td><td>${r.qty||0}</td>
      <td><button class='btn alt' data-e='${r.id}'>Edit</button> <button class='btn warn' data-x='${r.id}'>Del</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-e]').forEach(b=> b.onclick=()=>{
      const r=load().inventory.find(x=>x.id===b.getAttribute('data-e'));
      editInv=r.id; $('#sku').value=r.sku; $('#name').value=r.name; $('#cat').value=r.category||''; $('#cost').value=r.cost||''; $('#price').value=r.price||''; $('#qty').value=r.qty||0;
    });
    tb.querySelectorAll('button[data-x]').forEach(b=> b.onclick=()=>{ if(confirm('Delete item?')){ const d=load(); d.inventory=d.inventory.filter(x=>x.id!==b.getAttribute('data-x')); save(d); renderInventory(); } });
  }
  $('#invSave').addEventListener('click',()=>{
    const d=load(); const row={ id: editInv||id(), sku:$('#sku').value.trim(), name:$('#name').value.trim(), category:$('#cat').value.trim(), cost:Number($('#cost').value||0), price:Number($('#price').value||0), qty:Number($('#qty').value||0) };
    if(!row.sku||!row.name){ alert('SKU and Name are required'); return; }
    if(editInv){ const i=d.inventory.findIndex(x=>x.id===editInv); d.inventory[i]=row; } else { d.inventory.push(row); }
    save(d); editInv=null; ['sku','name','cat','cost','price','qty'].forEach(id=> $('#'+id).value=''); renderInventory();
  });
  $('#invClear').addEventListener('click',()=>{ editInv=null; ['sku','name','cat','cost','price','qty'].forEach(id=> $('#'+id).value=''); });
  $('#invSearch').addEventListener('input', renderInventory);
  $('#invAdd').addEventListener('click',()=>{ editInv=null; $('#sku').focus(); });
  $('#csv').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return; Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{
      const d=load(); (res.data||[]).forEach(r=>{ if(r.sku&&r.name){ d.inventory.push({id:id(), sku:String(r.sku).trim(), name:String(r.name).trim(), category:(r.category||'').trim(), cost:Number(r.cost||0), price:Number(r.price||0), qty:Number(r.qty||0)}); } });
      save(d); renderInventory(); alert('Bulk items added: '+(res.data||[]).length);
    }});
  });

  // =============== Comparison & Cash ================
  function monthKey(y,m){ return `${y}-${String(m).padStart(2,'0')}`; }
  function saveCash(){
    const y=Number($('#cbYear').value)||new Date().getFullYear(); const m=Number($('#cbMonth').value); const cash=Number($('#cbCash').value||0); const gcash=Number($('#cbGcash').value||0);
    const d=load(); if(!d.cash[y]) d.cash[y]={}; d.cash[y][m]= { cash, gcash }; save(d); alert('Saved.');
  }
  $('#cbSave').addEventListener('click', saveCash);

  function totalsByMonth(year){
    const d=load(); const out={};
    d.income.filter(r=> new Date(r.date).getFullYear()==year).forEach(r=>{ const m=new Date(r.date).getMonth()+1; out[m]=out[m]||{income:0,expense:0}; out[m].income+=Number(r.amount||0); });
    d.expenses.filter(r=> new Date(r.date).getFullYear()==year).forEach(r=>{ const m=new Date(r.date).getMonth()+1; out[m]=out[m]||{income:0,expense:0}; out[m].expense+=Number(r.amount||0); });
    return out; // {1:{income,expense}, ...}
  }

  let chartProfit;
  function runComparison(){
    const year=Number($('#cmpYear').value)||new Date().getFullYear();
    const map=totalsByMonth(year);
    const labels=[...Array(12)].map((_,i)=>monthNames[i]);
    const income=[...Array(12)].map((_,i)=> (map[i+1]?.income)||0);
    const expense=[...Array(12)].map((_,i)=> (map[i+1]?.expense)||0);
    const net=income.map((v,i)=> v-(expense[i]||0));
    const d=load(); const bal=d.cash[year]||{}; const cash=[...Array(12)].map((_,i)=> (bal[i+1]?.cash)||0); const gcash=[...Array(12)].map((_,i)=> (bal[i+1]?.gcash)||0);

    $('#cmpIncome').textContent=fmt(income.reduce((a,b)=>a+b,0));
    $('#cmpExpense').textContent=fmt(expense.reduce((a,b)=>a+b,0));
    $('#cmpNet').textContent=fmt(net.reduce((a,b)=>a+b,0));

    if(chartProfit) chartProfit.destroy();
    chartProfit = new Chart($('#chartProfit'), {type:'bar', data:{labels, datasets:[
      {label:'Net Profit', data:net},
      {label:'Cash on Hand', data:cash},
      {label:'GCash', data:gcash}
    ]}, options:{plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label:(c)=> c.dataset.label+': '+fmt(c.parsed.y)}}}, scales:{y:{beginAtZero:true}}});
  }
  $('#cmpRun').addEventListener('click', runComparison);

  // fill month select
  (function(){ const m=$('#cbMonth'); for(let i=1;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent=monthNames[i-1]; m.appendChild(o);} m.value=String(new Date().getMonth()+1); })();

  // =============== Print / Export Preview ================
  function renderPreview(){
    const d=load();
    const thead=$('#preview thead'); const tbody=$('#preview tbody');
    thead.innerHTML='<tr><th>Type</th><th>Date</th><th>Category</th><th>Method</th><th>Note</th><th>Amount</th></tr>';
    const rows=[...d.income.map(r=>({...r,_type:'Income'})), ...d.expenses.map(r=>({...r,_type:'Expense'}))].sort((a,b)=>new Date(b.date)-new Date(a.date));
    tbody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r._type}</td><td>${r.date}</td><td>${r.category||''}</td><td>${r.method||''}</td><td>${r.note||''}</td><td>${fmt(r.amount)}</td>`; tbody.appendChild(tr); });
  }
  $('#btnExport').addEventListener('click',()=>{
    const d=load(); const wb=XLSX.utils.book_new();
    const iData=[['Date','Category','Method','Note','Amount'], ...d.income.map(r=>[r.date,r.category||'',r.method||'',r.note||'',Number(r.amount||0)])];
    const eData=[['Date','Category','Method','Note','Amount'], ...d.expenses.map(r=>[r.date,r.category||'',r.method||'',r.note||'',Number(r.amount||0)])];
    const vData=[['SKU','Name','Category','Cost','Price','Qty'], ...d.inventory.map(r=>[r.sku,r.name,r.category||'',Number(r.cost||0),Number(r.price||0),Number(r.qty||0)])];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(iData),'Income');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(eData),'Expenses');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(vData),'Inventory');
    XLSX.writeFile(wb, 'InkHale-Data.xlsx');
  });
  $('#btnReset').addEventListener('click',()=>{ if(confirm('Erase ALL data?')){ localStorage.removeItem(KEY); location.reload(); }});

  // =============== Tabs ================
  document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    const name=btn.dataset.tab; document.querySelectorAll('main section').forEach(s=>s.hidden=true); $('#tab-'+name).hidden=false;
    if(name==='income') renderIncome();
    if(name==='expenses') renderExpenses();
    if(name==='inventory') renderInventory();
    if(name==='compare') runComparison();
    if(name==='print') renderPreview();
  }));

  // =============== Boot ================
  bootAuth();
  renderIncome(); renderExpenses(); renderInventory(); renderPreview();
</script>
</body>
</html>
